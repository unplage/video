<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light dark">
    <title>å®‰å…¨é€šä¿¡ - ç‚¹å¯¹ç‚¹åŠ å¯†é€šè¯</title>
    <style>
        :root {
            --wx-green: #07C160;
            --wx-green-dark: #06ad56;
            --wx-bg: #EDEDED;
            --wx-white: #FFFFFF;
            --wx-text: #000000;
            --wx-text-gray: #999999;
            --wx-border: #E5E5E5;
            --wx-link: #576b95;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px); /* å¢åŠ é»˜è®¤åº•éƒ¨å®‰å…¨è·ç¦» */
            --toolbar-height: 84px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --wx-bg: #111111;
                --wx-white: #1e1e1e;
                --wx-text: #ffffff;
                --wx-border: #2c2c2c;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
            background: var(--wx-bg);
            color: var(--wx-text);
            overscroll-behavior: none;
            display: flex;
            flex-direction: column;
        }

        /* é¡µé¢ç»“æ„ä¼˜åŒ– - ç¡®ä¿åº•éƒ¨å¯è§ */
        .app-container {
            height: 100%;
            height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .page.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* å¯¼èˆªæ  - ä½¿ç”¨paddingè€Œémarginç¡®ä¿å®‰å…¨åŒºåŸŸ */
        .nav-bar {
            flex-shrink: 0;
            background: var(--wx-bg);
            border-bottom: 0.5px solid var(--wx-border);
            padding: 12px 16px;
            padding-top: max(12px, var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            line-height: 1.2;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--wx-text);
            font-size: 16px;
            padding: 8px 12px;
            min-width: 44px;
            min-height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .nav-btn:active {
            opacity: 0.6;
            background: rgba(0,0,0,0.05);
        }

        /* å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            position: relative;
        }

        /* è¿æ¥é¡µé¢ä¼˜åŒ– */
        .connect-container {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 100%;
            padding-bottom: calc(16px + var(--safe-bottom));
        }

        .logo-area {
            text-align: center;
            padding: 30px 0;
            flex-shrink: 0;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: var(--wx-green);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
        }

        .step-tabs {
            display: flex;
            background: var(--wx-white);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
            flex-shrink: 0;
            border: 1px solid var(--wx-border);
        }

        .step-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .step-tab.active {
            background: var(--wx-green);
            color: white;
        }

        .input-group {
            background: var(--wx-white);
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid var(--wx-border);
            margin-bottom: 12px;
        }

        .input-label {
            font-size: 12px;
            color: var(--wx-text-gray);
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }

        textarea, input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
            color: var(--wx-text);
            font-family: inherit;
            resize: none;
            line-height: 1.4;
        }

        .btn-primary {
            background: var(--wx-green);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-bottom: 12px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:active {
            background: var(--wx-green-dark);
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background: var(--wx-white);
            color: var(--wx-text);
            border: 1px solid var(--wx-border);
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            width: 100%;
            min-height: 44px;
        }

        .info-box {
            background: rgba(7, 193, 96, 0.1);
            border-left: 4px solid var(--wx-green);
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--wx-text);
            margin-bottom: 16px;
        }

        .hidden { display: none !important; }

        /* ä¸»èŠå¤©é¡µ - å…³é”®ä¿®å¤ï¼šç¡®ä¿åº•éƒ¨å·¥å…·æ å§‹ç»ˆå¯è§ */
        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--wx-bg);
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px; /* é¢å¤–æ»šåŠ¨ç©ºé—´ */
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            align-items: flex-start;
            gap: 12px;
        }

        .message.self {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: #ccc;
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .avatar.green { background: var(--wx-green); }
        .avatar.blue { background: #576b95; }

        .bubble {
            background: var(--wx-white);
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .message.self .bubble {
            background: #95EB69;
        }

        /* å·¥å…·æ  - å…³é”®ä¿®å¤ï¼šä½¿ç”¨fixedå®šä½ç¡®ä¿å¯è§ */
        .toolbar {
            flex-shrink: 0;
            background: #f7f7f7;
            border-top: 0.5px solid var(--wx-border);
            padding: 12px 16px;
            padding-bottom: max(12px, var(--safe-bottom));
            display: flex;
            justify-content: center;
            gap: 40px;
            align-items: center;
            min-height: calc(64px + var(--safe-bottom));
            position: relative;
            z-index: 10;
        }

        .tool-btn {
            width: 56px;
            height: 56px;
            border: none;
            background: var(--wx-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .tool-btn:active {
            transform: scale(0.92);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .tool-btn.video { color: var(--wx-green); }
        .tool-btn.voice { color: #576b95; }

        /* é€šè¯ç•Œé¢ - å…¨å±è¦†ç›– */
        .call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            background: #1a1a1a;
            z-index: 1000;
            display: none;
            flex-direction: column;
            color: white;
            overflow: hidden;
        }

        .call-overlay.active {
            display: flex;
        }

        .call-header {
            padding: 16px;
            padding-top: max(16px, var(--safe-top));
            text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
            z-index: 10;
        }

        .call-peer-name {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .call-status {
            font-size: 13px;
            opacity: 0.9;
        }

        .call-video-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
        }

        #localVideo {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 100px;
            height: 133px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: #222;
            z-index: 5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .call-controls {
            padding: 20px 32px;
            padding-bottom: max(24px, var(--safe-bottom));
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            gap: 16px;
        }

        .control-btn {
            flex: 1;
            max-width: 72px;
            height: 64px;
            border-radius: 50%;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
        }

        .control-btn:active {
            transform: scale(0.9);
        }

        .control-btn .icon {
            font-size: 24px;
            line-height: 1;
        }

        .control-btn.end {
            background: #ff4d4f;
            max-width: 80px;
            height: 72px;
            flex: 1.2;
        }

        .control-btn.end .icon {
            font-size: 32px;
        }

        .control-btn.active {
            background: rgba(255,255,255,0.35);
        }

        /* è¯­éŸ³é€šè¯ç‰¹æ®Šå¸ƒå±€ */
        .voice-call-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .voice-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 24px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255,255,255,0.3);
        }

        .voice-wave {
            display: flex;
            gap: 4px;
            height: 30px;
            align-items: center;
            margin-bottom: 40px;
        }

        .wave-bar {
            width: 4px;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .wave-bar:nth-child(2) { height: 24px; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 18px; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 28px; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { height: 14px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.6); opacity: 0.7; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        /* æƒé™æç¤ºå¼¹çª— */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .permission-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--wx-white);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--wx-text);
        }

        .modal-text {
            font-size: 14px;
            color: var(--wx-text-gray);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-btn {
            background: var(--wx-green);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            min-height: 44px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            position: fixed;
            top: max(8px, var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 999;
            display: none;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        .connection-status.active {
            display: flex;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4d4f;
            animation: blink 1.5s infinite;
            flex-shrink: 0;
        }

        .status-dot.connected {
            background: var(--wx-green);
            animation: none;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ç½‘ç»œçŠ¶æ€æç¤º */
        .network-status {
            position: fixed;
            bottom: calc(100px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: #ff9500;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 998;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .network-status.active {
            display: flex;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
                margin: 0 auto;
                border-left: 1px solid var(--wx-border);
                border-right: 1px solid var(--wx-border);
            }
            
            .call-overlay {
                max-width: 480px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* Edgeæµè§ˆå™¨ç‰¹å®šä¼˜åŒ– */
        @supports (-ms-ime-align: auto) {
            .toolbar {
                padding-bottom: 24px; /* Edgeé¢å¤–åº•éƒ¨é—´è· */
            }
        }

        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-height: 600px) {
            .logo-area {
                padding: 20px 0;
            }
            .logo {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤º -->
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">ç­‰å¾…è¿æ¥...</span>
        </div>

        <!-- ç½‘ç»œè´¨é‡æç¤º -->
        <div class="network-status" id="networkStatus">
            <span>ğŸ“¶</span>
            <span>ç½‘ç»œåˆ‡æ¢ä¸­ï¼Œå°è¯•é‡è¿...</span>
        </div>

        <!-- æƒé™è¯·æ±‚æ¨¡æ€æ¡† -->
        <div class="permission-modal" id="permissionModal">
            <div class="modal-content">
                <div class="modal-icon" id="permIcon">ğŸ¤</div>
                <div class="modal-title" id="permTitle">éœ€è¦éº¦å…‹é£æƒé™</div>
                <div class="modal-text" id="permText">ä¸ºç¡®ä¿é€šè¯è´¨é‡ï¼Œè¯·å…è®¸åº”ç”¨è®¿é—®æ‚¨çš„éº¦å…‹é£</div>
                <button class="modal-btn" onclick="requestMediaPermission()">æˆæƒè®¿é—®</button>
            </div>
        </div>

        <!-- é¡µé¢1: è¿æ¥è®¾ç½® -->
        <div class="page active" id="connectPage">
            <div class="nav-bar">
                <div class="nav-btn" onclick="showHelp()">â“</div>
                <div class="nav-title">å®‰å…¨ç‚¹å¯¹ç‚¹é€šä¿¡</div>
                <div class="nav-btn" onclick="toggleTheme()">ğŸŒ“</div>
            </div>

            <div class="scrollable-content">
                <div class="connect-container">
                    <div class="logo-area">
                        <div class="logo">ğŸ”’</div>
                        <p style="margin-top: 12px; color: var(--wx-text-gray); font-size: 14px;">ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡</p>
                    </div>

                    <div class="step-tabs">
                        <div class="step-tab active" onclick="switchTab('create')" id="tabCreate">åˆ›å»ºè¿æ¥</div>
                        <div class="step-tab" onclick="switchTab('join')" id="tabJoin">åŠ å…¥è¿æ¥</div>
                    </div>

                    <!-- åˆ›å»ºè€…æµç¨‹ -->
                    <div id="createPanel">
                        <div class="info-box">
                            <strong>æ­¥éª¤è¯´æ˜ï¼š</strong><br>
                            1. ç‚¹å‡»ç”Ÿæˆè¿æ¥ç ï¼ˆæ”¯æŒè·¨WiFiï¼‰<br>
                            2. å¤åˆ¶SDPä»£ç å‘é€ç»™å¯¹æ–¹<br>
                            3. ç­‰å¾…å¯¹æ–¹å›å¤Answerä»£ç <br>
                            4. ç²˜è´´Answerå®ŒæˆP2Pè¿æ¥
                        </div>

                        <button class="btn-primary" onclick="createOffer()" id="createBtn">
                            <span>ç”Ÿæˆè¿æ¥ç </span>
                            <span style="font-size: 12px; opacity: 0.9;">(Offer)</span>
                        </button>
                        
                        <div class="input-group" style="display: none;" id="offerBox">
                            <label class="input-label">ğŸ“‹ å¤åˆ¶ä»¥ä¸‹ä»£ç å‘é€ç»™å¯¹æ–¹ï¼ˆåŒ…å«TURNå€™é€‰ï¼‰ï¼š</label>
                            <textarea id="offerSdp" rows="5" readonly onclick="this.select()"></textarea>
                        </div>

                        <div class="input-group" style="display: none;" id="answerInputBox">
                            <label class="input-label">ğŸ“¥ ç²˜è´´å¯¹æ–¹å‘æ¥çš„Answerä»£ç ï¼š</label>
                            <textarea id="answerSdp" rows="4" placeholder="åœ¨æ­¤ç²˜è´´Answer..."></textarea>
                            <button class="btn-primary" style="margin-top: 12px; margin-bottom: 0;" onclick="handleAnswer()">ç¡®è®¤è¿æ¥</button>
                        </div>
                    </div>

                    <!-- åŠ å…¥è€…æµç¨‹ -->
                    <div id="joinPanel" class="hidden">
                        <div class="info-box">
                            <strong>æ­¥éª¤è¯´æ˜ï¼š</strong><br>
                            1. è·å–å¯¹æ–¹æä¾›çš„Offerä»£ç <br>
                            2. ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†<br>
                            3. ç”ŸæˆAnswerå›å¤ä»£ç <br>
                            4. å‘é€ç»™å¯¹æ–¹å®Œæˆè¿æ¥
                        </div>

                        <div class="input-group">
                            <label class="input-label">ğŸ“¥ ç²˜è´´å¯¹æ–¹çš„Offerä»£ç ï¼š</label>
                            <textarea id="remoteOffer" rows="4" placeholder="åœ¨æ­¤ç²˜è´´Offer..."></textarea>
                        </div>

                        <button class="btn-primary" style="margin-top: 4px;" onclick="createAnswer()" id="answerBtn">
                            <span>ç”Ÿæˆå›å¤ä»£ç </span>
                            <span style="font-size: 12px; opacity: 0.9;">(Answer)</span>
                        </button>

                        <div class="input-group" style="display: none;" id="answerBox">
                            <label class="input-label">ğŸ“‹ å¤åˆ¶ä»¥ä¸‹ä»£ç å‘ç»™å¯¹æ–¹ï¼š</label>
                            <textarea id="answerSdpOutput" rows="5" readonly onclick="this.select()"></textarea>
                        </div>
                    </div>

                    <div style="margin-top: auto; padding: 20px 0; text-align: center; font-size: 12px; color: var(--wx-text-gray); line-height: 1.6;">
                        <p>ğŸ”’ åŸºäºWebRTC DTLS-SRTPåŠ å¯†</p>
                        <p style="margin-top: 4px;">æ”¯æŒç©¿é€å¤šæ•°NAT/é˜²ç«å¢™</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢2: ä¸»èŠå¤©ç•Œé¢ -->
        <div class="page" id="chatPage">
            <div class="nav-bar">
                <button class="nav-btn" onclick="backToConnect()">â€¹ è¿”å›</button>
                <div class="nav-title">åŠ å¯†é€šè¯</div>
                <button class="nav-btn" onclick="showPeerInfo()">â„¹ï¸</button>
            </div>

            <div class="chat-content" id="chatContent">
                <div style="text-align: center; color: var(--wx-text-gray); font-size: 13px; margin: 16px 0;">
                    å®‰å…¨é€šé“å·²å»ºç«‹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹é€šè¯
                </div>
                
                <div class="message">
                    <div class="avatar green">ç³»</div>
                    <div class="bubble">æ¬¢è¿ä½¿ç”¨ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡ç³»ç»Ÿã€‚æ”¯æŒè·¨ç½‘ç»œã€è·¨è¿è¥å•†è¿æ¥ã€‚</div>
                </div>

                <div class="message">
                    <div class="avatar blue">å®‰</div>
                    <div class="bubble">ç³»ç»Ÿå·²é…ç½®STUN/TURNæœåŠ¡å™¨ï¼Œå¯è‡ªåŠ¨å¤„ç†ä¸åŒWiFiç¯å¢ƒä¸‹çš„è¿æ¥ã€‚</div>
                </div>
            </div>

            <div class="toolbar">
                <button class="tool-btn voice" onclick="initiateCall('audio')" title="è¯­éŸ³é€šè¯">
                    <span style="font-size: 28px;">ğŸ“</span>
                </button>
                <button class="tool-btn video" onclick="initiateCall('video')" title="è§†é¢‘é€šè¯">
                    <span style="font-size: 28px;">ğŸ“¹</span>
                </button>
            </div>
        </div>

        <!-- é¡µé¢3: è§†é¢‘é€šè¯ç•Œé¢ -->
        <div class="call-overlay" id="videoCallOverlay">
            <div class="call-header">
                <div class="call-peer-name">å¯¹æ–¹</div>
                <div class="call-status" id="videoCallStatus">æ­£åœ¨å»ºç«‹å®‰å…¨è¿æ¥...</div>
            </div>

            <div class="call-video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>

            <div class="call-controls">
                <button class="control-btn mute" id="muteBtn" onclick="toggleMute()">
                    <span class="icon">ğŸ¤</span>
                    <span>é™éŸ³</span>
                </button>
                <button class="control-btn switch" onclick="switchCamera()">
                    <span class="icon">ğŸ”„</span>
                    <span>åˆ‡æ¢</span>
                </button>
                <button class="control-btn speaker" id="speakerBtn" onclick="toggleSpeaker()">
                    <span class="icon">ğŸ”Š</span>
                    <span>å…æ</span>
                </button>
                <button class="control-btn end" onclick="endCall()">
                    <span class="icon">ğŸ“</span>
                </button>
            </div>
        </div>

        <!-- é¡µé¢4: è¯­éŸ³é€šè¯ç•Œé¢ -->
        <div class="call-overlay" id="voiceCallOverlay">
            <div class="voice-call-bg">
                <div class="call-header" style="position: absolute; top: 0; left: 0; width: 100%; background: transparent;">
                    <div style="height: var(--safe-top);"></div>
                    <div class="call-peer-name" style="margin-top: 20px;">å¯¹æ–¹</div>
                    <div class="call-status" id="voiceCallStatus">åŠ å¯†è¯­éŸ³é€šè¯ä¸­...</div>
                </div>

                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 60px;">
                    <div class="voice-avatar-large" id="voiceAvatar">ğŸ‘¤</div>
                    
                    <div class="voice-wave" id="voiceWave">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                </div>

                <div class="call-controls" style="background: rgba(0,0,0,0.2); margin-bottom: 20px;">
                    <button class="control-btn mute" id="voiceMuteBtn" onclick="toggleMute()">
                        <span class="icon">ğŸ¤</span>
                        <span>é™éŸ³</span>
                    </button>
                    <button class="control-btn speaker" id="voiceSpeakerBtn" onclick="toggleSpeaker()">
                        <span class="icon">ğŸ”Š</span>
                        <span>å…æ</span>
                    </button>
                    <button class="control-btn end" onclick="endCall()">
                        <span class="icon">ğŸ“</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å¢å¼ºçš„WebRTCé…ç½® ====================
        // åŒ…å«TURNæœåŠ¡å™¨é…ç½®ï¼Œè§£å†³è·¨WiFi/ä¸¥æ ¼NATç¯å¢ƒä¸‹çš„è¿æ¥é—®é¢˜
        const iceServers = [
            // Googleå…¬å…±STUNæœåŠ¡å™¨
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            // å¼€æºTURNæœåŠ¡å™¨ï¼ˆç”¨äºå¯¹ç§°NATç©¿é€ï¼‰
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            // å¤‡ç”¨TURNï¼ˆTCPä¼ è¾“ï¼Œç©¿é€é˜²ç«å¢™ï¼‰
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ];

        const configuration = {
            iceServers: iceServers,
            iceCandidatePoolSize: 10,
            iceTransportPolicy: 'all', // å…è®¸æ‰€æœ‰ä¼ è¾“æ–¹å¼
            bundlePolicy: 'max-bundle',
            rtcpMuxPolicy: 'require'
        };

        // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
        let pc = null;
        let localStream = null;
        let currentCallType = null;
        let isMuted = false;
        let isSpeakerOn = false;
        let currentFacingMode = 'user';
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 3;
        let iceCandidatesQueue = [];
        
        // ==================== DOM å…ƒç´ ç¼“å­˜ ====================
        const elements = {
            connectPage: document.getElementById('connectPage'),
            chatPage: document.getElementById('chatPage'),
            videoCallOverlay: document.getElementById('videoCallOverlay'),
            voiceCallOverlay: document.getElementById('voiceCallOverlay'),
            permissionModal: document.getElementById('permissionModal'),
            connectionStatus: document.getElementById('connectionStatus'),
            networkStatus: document.getElementById('networkStatus'),
            localVideo: document.getElementById('localVideo'),
            remoteVideo: document.getElementById('remoteVideo'),
            offerSdp: document.getElementById('offerSdp'),
            answerSdp: document.getElementById('answerSdp'),
            remoteOffer: document.getElementById('remoteOffer'),
            answerSdpOutput: document.getElementById('answerSdpOutput'),
            chatContent: document.getElementById('chatContent')
        };

        // ==================== åˆå§‹åŒ–ä¸ç½‘ç»œç›‘å¬ ====================
        document.addEventListener('DOMContentLoaded', () => {
            checkMediaPermissions();
            setupNetworkListeners();
            
            // Edgeæµè§ˆå™¨ç‰¹å®šï¼šå¼ºåˆ¶é‡ç»˜ä»¥è®¡ç®—å®‰å…¨åŒºåŸŸ
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 100);
        });

        // ç›‘å¬ç½‘ç»œå˜åŒ–ï¼Œè‡ªåŠ¨é‡è¿
        function setupNetworkListeners() {
            if ('connection' in navigator) {
                navigator.connection.addEventListener('change', handleNetworkChange);
            }
            window.addEventListener('online', () => {
                console.log('ç½‘ç»œå·²æ¢å¤');
                if (pc && pc.connectionState === 'disconnected') {
                    attemptReconnect();
                }
            });
            window.addEventListener('offline', () => {
                showNetworkStatus(true, 'ç½‘ç»œå·²æ–­å¼€');
            });
        }

        function handleNetworkChange() {
            const connection = navigator.connection;
            console.log('ç½‘ç»œç±»å‹:', connection.effectiveType);
            
            if (pc && pc.connectionState === 'connected') {
                // è°ƒæ•´ç ç‡é€‚åº”ç½‘ç»œ
                adjustBitrate(connection.effectiveType);
            }
        }

        function adjustBitrate(networkType) {
            const senders = pc.getSenders();
            senders.forEach(sender => {
                if (sender.track && sender.track.kind === 'video') {
                    const params = sender.getParameters();
                    if (params.encodings && params.encodings.length > 0) {
                        // æ ¹æ®ç½‘ç»œè´¨é‡è°ƒæ•´
                        if (networkType === '4g') {
                            params.encodings[0].maxBitrate = 2500000; // 2.5Mbps
                        } else if (networkType === '3g') {
                            params.encodings[0].maxBitrate = 500000; // 500kbps
                        } else {
                            params.encodings[0].maxBitrate = 150000; // 150kbps
                        }
                        sender.setParameters(params);
                    }
                }
            });
        }

        function showNetworkStatus(show, text) {
            const el = document.getElementById('networkStatus');
            if (show) {
                el.querySelector('span:last-child').textContent = text;
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        }

        // ==================== æƒé™ç®¡ç† ====================
        async function checkMediaPermissions() {
            if (navigator.permissions) {
                try {
                    const mic = await navigator.permissions.query({ name: 'microphone' });
                    const cam = await navigator.permissions.query({ name: 'camera' });
                    
                    if (mic.state === 'denied' || cam.state === 'denied') {
                        alert('è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£å’Œæ‘„åƒå¤´æƒé™ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œé€šè¯');
                    }
                } catch (e) {
                    console.log('æƒé™æŸ¥è¯¢ä¸æ”¯æŒ');
                }
            }
        }

        function showPermissionModal(type) {
            const icon = type === 'video' ? 'ğŸ“¹' : 'ğŸ¤';
            const title = type === 'video' ? 'éœ€è¦æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™' : 'éœ€è¦éº¦å…‹é£æƒé™';
            const text = type === 'video' 
                ? 'è§†é¢‘é€šè¯éœ€è¦è®¿é—®æ‚¨çš„æ‘„åƒå¤´å’Œéº¦å…‹é£ã€‚æ•°æ®é€šè¿‡ç‚¹å¯¹ç‚¹åŠ å¯†ä¼ è¾“ï¼Œä¸ä¼šç»è¿‡æœåŠ¡å™¨å­˜å‚¨ã€‚'
                : 'è¯­éŸ³é€šè¯éœ€è¦è®¿é—®æ‚¨çš„éº¦å…‹é£ã€‚æ•°æ®é€šè¿‡ç‚¹å¯¹ç‚¹åŠ å¯†ä¼ è¾“ï¼Œç¡®ä¿éšç§å®‰å…¨ã€‚';
            
            document.getElementById('permIcon').textContent = icon;
            document.getElementById('permTitle').textContent = title;
            document.getElementById('permText').textContent = text;
            elements.permissionModal.classList.add('active');
        }

        async function requestMediaPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000
                    }, 
                    video: currentCallType === 'video' 
                });
                stream.getTracks().forEach(track => track.stop());
                elements.permissionModal.classList.remove('active');
                
                if (currentCallType) {
                    startActualCall();
                }
            } catch (err) {
                alert('æ— æ³•è·å–æƒé™ï¼š' + err.message + '\nè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
                elements.permissionModal.classList.remove('active');
                currentCallType = null;
            }
        }

        // ==================== WebRTC æ ¸å¿ƒé€»è¾‘ï¼ˆå¢å¼ºç¨³å®šæ€§ï¼‰ ====================
        function createPeerConnection() {
            pc = new RTCPeerConnection(configuration);

            // ICEå€™é€‰æ”¶é›†ç›‘æ§
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('æ”¶é›†åˆ°ICEå€™é€‰:', event.candidate.type);
                    iceCandidatesQueue.push(event.candidate);
                } else {
                    console.log('ICEæ”¶é›†å®Œæˆ');
                }
            };

            pc.onicegatheringstatechange = () => {
                console.log('ICEæ”¶é›†çŠ¶æ€:', pc.iceGatheringState);
            };

            pc.oniceconnectionstatechange = () => {
                console.log('ICEè¿æ¥çŠ¶æ€:', pc.iceConnectionState);
                handleICEStateChange(pc.iceConnectionState);
            };

            pc.ontrack = (event) => {
                console.log('æ”¶åˆ°è¿œç«¯æµ');
                if (event.streams && event.streams[0]) {
                    elements.remoteVideo.srcObject = event.streams[0];
                    updateCallStatus('å·²è¿æ¥');
                    
                    // ç›‘æ§è¿œç«¯éŸ³é¢‘çº§åˆ«ï¼ˆç”¨äºè¯­éŸ³é€šè¯åŠ¨ç”»ï¼‰
                    if (currentCallType === 'audio') {
                        monitorAudioLevel(event.streams[0]);
                    }
                }
            };

            pc.onconnectionstatechange = () => {
                console.log('è¿æ¥çŠ¶æ€å˜åŒ–:', pc.connectionState);
                updateConnectionStatus(pc.connectionState);
                
                if (pc.connectionState === 'disconnected') {
                    setTimeout(() => {
                        if (pc.connectionState === 'disconnected') {
                            attemptReconnect();
                        }
                    }, 3000);
                } else if (pc.connectionState === 'failed') {
                    showNetworkStatus(true, 'è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            // ç›‘å¬æ•°æ®é€šé“ï¼ˆç”¨äºæ§åˆ¶æ¶ˆæ¯ï¼‰
            pc.ondatachannel = (event) => {
                setupDataChannel(event.channel);
            };

            return pc;
        }

        function handleICEStateChange(state) {
            switch(state) {
                case 'checking':
                    showNetworkStatus(true, 'æ­£åœ¨å¯»æ‰¾æœ€ä½³è¿æ¥è·¯å¾„...');
                    break;
                case 'connected':
                case 'completed':
                    showNetworkStatus(false);
                    reconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
                    break;
                case 'disconnected':
                    showNetworkStatus(true, 'ç½‘ç»œä¸ç¨³å®šï¼Œæ­£åœ¨å°è¯•æ¢å¤...');
                    break;
                case 'failed':
                    showNetworkStatus(true, 'è¿æ¥å¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥é˜²ç«å¢™è®¾ç½®');
                    break;
            }
        }

        async function createOffer() {
            createPeerConnection();
            
            // åˆ›å»ºæ•°æ®é€šé“
            const dataChannel = pc.createDataChannel('control', {
                ordered: true,
                maxRetransmits: 3
            });
            setupDataChannel(dataChannel);

            try {
                // åˆ›å»ºOfferï¼ˆåŒ…å«æ‰€æœ‰ICEå€™é€‰ï¼‰
                const offer = await pc.createOffer({
                    offerToReceiveAudio: 1,
                    offerToReceiveVideo: 1
                });
                
                await pc.setLocalDescription(offer);
                
                // ç­‰å¾…ICEæ”¶é›†å®Œæˆï¼ˆåŒ…æ‹¬TURNå€™é€‰ï¼‰
                await waitForICEComplete();
                
                // ç”Ÿæˆå®Œæ•´çš„SDPåŒ…å«æ‰€æœ‰å€™é€‰
                const completeOffer = pc.localDescription;
                elements.offerSdp.value = btoa(JSON.stringify(completeOffer));
                
                document.getElementById('offerBox').style.display = 'block';
                document.getElementById('answerInputBox').style.display = 'block';
                document.getElementById('createBtn').style.display = 'none';
                
                updateConnectionStatus('connecting');

            } catch (err) {
                alert('åˆ›å»ºè¿æ¥å¤±è´¥ï¼š' + err.message);
                console.error(err);
            }
        }

        async function createAnswer() {
            const offerStr = elements.remoteOffer.value.trim();
            if (!offerStr) {
                alert('è¯·è¾“å…¥å¯¹æ–¹æä¾›çš„Offerä»£ç ');
                return;
            }

            createPeerConnection();

            try {
                const offer = JSON.parse(atob(offerStr));
                await pc.setRemoteDescription(offer);
                
                // å¦‚æœè¿œç«¯æä¾›äº†ICEå€™é€‰ï¼Œæ·»åŠ åˆ°æœ¬åœ°
                if (offer.iceCandidates) {
                    offer.iceCandidates.forEach(candidate => {
                        pc.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                // ç­‰å¾…ICEæ”¶é›†å®Œæˆ
                await waitForICEComplete();
                
                elements.answerSdpOutput.value = btoa(JSON.stringify(pc.localDescription));
                document.getElementById('answerBox').style.display = 'block';
                document.getElementById('answerBtn').style.display = 'none';
                
                updateConnectionStatus('connecting');
                
            } catch (err) {
                alert('åˆ›å»ºå›å¤å¤±è´¥ï¼š' + err.message);
                console.error(err);
            }
        }

        async function handleAnswer() {
            const answerStr = elements.answerSdp.value.trim();
            if (!answerStr) {
                alert('è¯·è¾“å…¥å¯¹æ–¹æä¾›çš„Answerä»£ç ');
                return;
            }

            try {
                const answer = JSON.parse(atob(answerStr));
                await pc.setRemoteDescription(answer);
                
                // å¤„ç†ICEå€™é€‰ï¼ˆå¦‚æœåŒ…å«ï¼‰
                if (answer.iceCandidates) {
                    answer.iceCandidates.forEach(candidate => {
                        pc.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
                
                enterChat();
            } catch (err) {
                alert('è¿æ¥å¤±è´¥ï¼š' + err.message);
            }
        }

        // ç­‰å¾…ICEæ”¶é›†å®Œæˆçš„Promise
        function waitForICEComplete() {
            return new Promise((resolve) => {
                if (pc.iceGatheringState === 'complete') {
                    resolve();
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    if (pc.iceGatheringState === 'complete') {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 500);
                
                // æœ€é•¿ç­‰å¾…5ç§’ï¼ˆTURNå¯èƒ½è¾ƒæ…¢ï¼‰
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }

        // å°è¯•é‡è¿
        async function attemptReconnect() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                showNetworkStatus(true, 'è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°å»ºç«‹è¿æ¥');
                return;
            }
            
            reconnectAttempts++;
            showNetworkStatus(true, `å°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})...`);
            
            try {
                // é‡å¯ICE
                await pc.restartIce();
            } catch (e) {
                console.error('é‡è¿å¤±è´¥:', e);
            }
        }

        // ==================== é€šè¯æ§åˆ¶ ====================
        async function initiateCall(type) {
            currentCallType = type;
            
            if (!pc || pc.connectionState !== 'connected') {
                alert('è¯·å…ˆå®Œæˆç‚¹å¯¹ç‚¹è¿æ¥');
                return;
            }

            showPermissionModal(type);
        }

        async function startActualCall() {
            try {
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000,
                        channelCount: 1
                    },
                    video: currentCallType === 'video' ? {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    } : false
                };

                // Edgeæµè§ˆå™¨ä¼˜åŒ–ï¼šå…ˆè¯·æ±‚éŸ³é¢‘ï¼Œå†æ·»åŠ è§†é¢‘ï¼ˆé¿å…å¹¶å‘è¯·æ±‚é—®é¢˜ï¼‰
                localStream = await navigator.mediaDevices.getUserMedia(constraints);

                // æ·»åŠ è½¨é“åˆ°PeerConnection
                localStream.getTracks().forEach(track => {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç±»å‹çš„å‘é€å™¨ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
                    const senders = pc.getSenders();
                    const existingSender = senders.find(s => s.track && s.track.kind === track.kind);
                    if (existingSender) {
                        existingSender.replaceTrack(track);
                    } else {
                        pc.addTrack(track, localStream);
                    }
                });

                if (currentCallType === 'video') {
                    elements.localVideo.srcObject = localStream;
                    elements.videoCallOverlay.classList.add('active');
                    updateCallStatus('è§†é¢‘é€šè¯ä¸­');
                } else {
                    elements.voiceCallOverlay.classList.add('active');
                    updateCallStatus('è¯­éŸ³é€šè¯ä¸­');
                }

                // åˆ›å»ºå¹¶å‘é€Offeræ›´æ–°ï¼ˆåå•†åª’ä½“ï¼‰
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
            } catch (err) {
                console.error('å¯åŠ¨é€šè¯å¤±è´¥:', err);
                let msg = 'å¯åŠ¨é€šè¯å¤±è´¥ï¼š';
                if (err.name === 'NotAllowedError') {
                    msg += 'æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (err.name === 'NotReadableError') {
                    msg += 'æ‘„åƒå¤´/éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨';
                } else {
                    msg += err.message;
                }
                alert(msg);
                currentCallType = null;
            }
        }

        function endCall() {
            // åœæ­¢æ‰€æœ‰åª’ä½“æµ
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    // ä»PCä¸­ç§»é™¤è½¨é“
                    const senders = pc.getSenders();
                    const sender = senders.find(s => s.track === track);
                    if (sender) {
                        pc.removeTrack(sender);
                    }
                });
                localStream = null;
            }
            
            elements.videoCallOverlay.classList.remove('active');
            elements.voiceCallOverlay.classList.remove('active');
            currentCallType = null;
            isMuted = false;
            updateCallStatus('');
        }

        function toggleMute() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isMuted = !audioTrack.enabled;
                
                const btn = currentCallType === 'video' ? document.getElementById('muteBtn') : document.getElementById('voiceMuteBtn');
                updateControlButton(btn, isMuted, 'ğŸš«', 'ğŸ¤');
            }
        }

        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            const btn = currentCallType === 'video' ? document.getElementById('speakerBtn') : document.getElementById('voiceSpeakerBtn');
            
            // å®é™…åˆ‡æ¢éŸ³é¢‘è¾“å‡ºè®¾å¤‡
            if (elements.remoteVideo.setSinkId) {
                elements.remoteVideo.setSinkId(isSpeakerOn ? 'default' : 'communications')
                    .catch(e => console.log('åˆ‡æ¢éŸ³é¢‘è¾“å‡ºå¤±è´¥:', e));
            }
            
            updateControlButton(btn, isSpeakerOn, 'ğŸ”ˆ', 'ğŸ”Š');
        }

        async function switchCamera() {
            if (currentCallType !== 'video' || !localStream) return;
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode },
                    audio: false // ä¸é‡å¤è·å–éŸ³é¢‘
                });
                
                const newVideoTrack = newStream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                
                if (sender) {
                    await sender.replaceTrack(newVideoTrack);
                }
                
                // æ›´æ–°æœ¬åœ°é¢„è§ˆ
                const oldVideoTrack = localStream.getVideoTracks()[0];
                if (oldVideoTrack) {
                    localStream.removeTrack(oldVideoTrack);
                    oldVideoTrack.stop();
                }
                localStream.addTrack(newVideoTrack);
                elements.localVideo.srcObject = localStream;
                
            } catch (err) {
                alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥ï¼š' + err.message);
            }
        }

        // ç›‘æ§éŸ³é¢‘ç”µå¹³ï¼ˆç”¨äºè¯­éŸ³ç•Œé¢åŠ¨ç”»ï¼‰
        function monitorAudioLevel(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateWave() {
                if (!currentCallType === 'audio') return;
                
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                const scale = Math.max(0.5, Math.min(1, average / 128));
                
                // è°ƒæ•´æ³¢æµªåŠ¨ç”»é€Ÿåº¦
                document.querySelectorAll('.wave-bar').forEach(bar => {
                    bar.style.animationDuration = `${1/scale}s`;
                });
                
                requestAnimationFrame(updateWave);
            }
            updateWave();
        }

        // ==================== UI è¾…åŠ©å‡½æ•° ====================
        function updateControlButton(btn, isActive, activeIcon, normalIcon) {
            if (isActive) {
                btn.classList.add('active');
                btn.querySelector('.icon').textContent = activeIcon;
            } else {
                btn.classList.remove('active');
                btn.querySelector('.icon').textContent = normalIcon;
            }
        }

        function updateCallStatus(status) {
            document.getElementById('videoCallStatus').textContent = status;
            document.getElementById('voiceCallStatus').textContent = status;
        }

        function enterChat() {
            elements.connectPage.classList.remove('active');
            elements.chatPage.classList.add('active');
            updateConnectionStatus('connected');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                elements.chatContent.scrollTop = elements.chatContent.scrollHeight;
            }, 100);
        }

        function backToConnect() {
            if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å¹¶è¿”å›ï¼Ÿ')) {
                if (pc) {
                    pc.close();
                    pc = null;
                }
                location.reload();
            }
        }

        function updateConnectionStatus(state) {
            const statusEl = elements.connectionStatus;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            const statusMap = {
                'new': { text: 'å‡†å¤‡è¿æ¥', show: true },
                'checking': { text: 'è¿æ¥ä¸­...', show: true },
                'connected': { text: 'å·²è¿æ¥', show: true },
                'completed': { text: 'è¿æ¥ç¨³å®š', show: true },
                'disconnected': { text: 'è¿æ¥æ–­å¼€', show: true },
                'failed': { text: 'è¿æ¥å¤±è´¥', show: true },
                'closed': { text: 'è¿æ¥å·²å…³é—­', show: false }
            };
            
            const info = statusMap[state] || { text: 'æœªçŸ¥çŠ¶æ€', show: false };
            
            if (info.show) {
                statusEl.classList.add('active');
                text.textContent = info.text;
                if (state === 'connected' || state === 'completed') {
                    dot.classList.add('connected');
                    setTimeout(() => statusEl.classList.remove('active'), 3000);
                } else {
                    dot.classList.remove('connected');
                }
            } else {
                statusEl.classList.remove('active');
            }
        }

        function switchTab(tab) {
            document.getElementById('tabCreate').classList.toggle('active', tab === 'create');
            document.getElementById('tabJoin').classList.toggle('active', tab === 'join');
            document.getElementById('createPanel').classList.toggle('hidden', tab !== 'create');
            document.getElementById('joinPanel').classList.toggle('hidden', tab !== 'join');
        }

        function showHelp() {
            alert('è·¨ç½‘ç»œè¿æ¥æŒ‡å—ï¼š\n\n1. ç¡®ä¿åŒæ–¹éƒ½å·²æˆæƒæ‘„åƒå¤´/éº¦å…‹é£æƒé™\n2. ä¸€æ–¹"åˆ›å»ºè¿æ¥"ï¼Œå¦ä¸€æ–¹"åŠ å…¥è¿æ¥"\n3. é€šè¿‡ä»»æ„æ–¹å¼ï¼ˆå¾®ä¿¡/çŸ­ä¿¡/é‚®ä»¶ï¼‰äº¤æ¢ä»£ç \n4. ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³è¿æ¥è·¯å¾„ï¼ˆP2Pä¼˜å…ˆï¼‰\n5. å¦‚è¿æ¥å¤±è´¥ï¼Œå»ºè®®å°è¯•åˆ‡æ¢åˆ°ç§»åŠ¨æ•°æ®\n\næ”¯æŒï¼šWiFiâ†”4Gã€å†…ç½‘â†”å¤–ç½‘ã€é˜²ç«å¢™ç©¿é€');
        }

        function showPeerInfo() {
            const state = pc ? pc.connectionState : 'unknown';
            const iceState = pc ? pc.iceConnectionState : 'unknown';
            const selectedCandidate = pc ? pc.getRemoteStreams().length : 0;
            
            let info = `è¿æ¥çŠ¶æ€ï¼š${state}\n`;
            info += `ICEçŠ¶æ€ï¼š${iceState}\n`;
            info += `åŠ å¯†åè®®ï¼šDTLS-SRTP\n`;
            info += `ä¼ è¾“æ–¹å¼ï¼š${iceState === 'connected' ? 'P2Pç›´è¿' : 'TURNä¸­ç»§'}\n`;
            info += `ICEæœåŠ¡å™¨ï¼š${configuration.iceServers.length}ä¸ªèŠ‚ç‚¹`;
            
            alert(info);
        }

        function toggleTheme() {
            // ç®€å•çš„åè‰²æ•ˆæœ
            document.body.style.filter = document.body.style.filter === 'invert(1)' ? '' : 'invert(1)';
        }

        function setupDataChannel(channel) {
            channel.onopen = () => console.log('æ§åˆ¶é€šé“å·²æ‰“å¼€');
            channel.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'hangup') {
                    endCall();
                    alert('å¯¹æ–¹å·²æŒ‚æ–­');
                }
            };
        }

        // é˜²æ­¢ç§»åŠ¨ç«¯é»˜è®¤è¡Œä¸º
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) e.preventDefault();
        }, { passive: false });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // æ¸…ç†èµ„æº
        window.onbeforeunload = () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (pc) {
                pc.close();
            }
        };
    </script>
</body>
</html>
