<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易视频通话</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .video-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 500px;
        }
        
        .video-wrapper {
            flex: 1;
            background: #1e293b;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }
        
        #localVideo, #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .panel-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #4f46e5;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 20px;
        }
        
        .code-display {
            background: linear-gradient(45deg, #f0f9ff, #e0f2fe);
            border: 2px dashed #38bdf8;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 5px;
            color: #0c4a6e;
            margin: 10px 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 500;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .call-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            font-weight: 500;
        }
        
        .status-connecting {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .device-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .icon {
            font-size: 20px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            .video-container, .control-panel {
                min-width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-video"></i> 简易视频通话</h1>
            <p>跨WiFi直接连接，输入验证码即可通话</p>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-user-plus"></i>
                        <span>我的验证码</span>
                    </div>
                    <div class="code-display" id="myCode">生成中...</div>
                    <div class="input-group">
                        <label><i class="fas fa-key"></i> 输入对方验证码连接</label>
                        <div class="input-with-button">
                            <input type="text" id="peerCode" placeholder="输入6位验证码" maxlength="6">
                            <button class="btn btn-primary" id="connectBtn">
                                <i class="fas fa-plug"></i> 连接
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>设备设置</span>
                    </div>
                    <div class="input-group">
                        <label>摄像头</label>
                        <select class="device-select" id="cameraSelect"></select>
                    </div>
                    <div class="input-group">
                        <label>麦克风</label>
                        <select class="device-select" id="micSelect"></select>
                    </div>
                    <div class="call-controls">
                        <button class="btn btn-secondary" id="refreshDevices">
                            <i class="fas fa-redo"></i> 刷新设备
                        </button>
                        <button class="btn btn-primary" id="toggleAudio">
                            <i class="fas fa-microphone"></i> 静音
                        </button>
                        <button class="btn btn-primary" id="toggleVideo">
                            <i class="fas fa-video"></i> 关闭视频
                        </button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        <span>连接状态</span>
                    </div>
                    <div class="status" id="connectionStatus">
                        等待连接...
                    </div>
                    <div class="call-controls">
                        <button class="btn btn-success" id="callBtn" disabled>
                            <i class="fas fa-phone"></i> 开始通话
                        </button>
                        <button class="btn btn-danger" id="hangupBtn" disabled>
                            <i class="fas fa-phone-slash"></i> 挂断
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="video-container">
                <div class="video-wrapper">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">本地视频</div>
                </div>
                <div class="video-wrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label">远程视频</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
// 配置
const CONFIG = {
    SIGNALING_SERVER: 'https://simple-webrtc-signal.glitch.me', // 公共信令服务器
    ICE_SERVERS: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        {
            urls: 'turn:numb.viagenie.ca',
            credential: 'muazkh',
            username: 'webrtc@live.com'
        }
    ],
    CODE_LENGTH: 6
};

// 全局变量
let socket;
let peerConnection;
let localStream;
let myCode;
let peerCode;
let isCaller = false;
let isAudioEnabled = true;
let isVideoEnabled = true;

// DOM元素
const elements = {
    myCode: document.getElementById('myCode'),
    peerCodeInput: document.getElementById('peerCode'),
    connectBtn: document.getElementById('connectBtn'),
    callBtn: document.getElementById('callBtn'),
    hangupBtn: document.getElementById('hangupBtn'),
    localVideo: document.getElementById('localVideo'),
    remoteVideo: document.getElementById('remoteVideo'),
    connectionStatus: document.getElementById('connectionStatus'),
    cameraSelect: document.getElementById('cameraSelect'),
    micSelect: document.getElementById('micSelect'),
    refreshDevices: document.getElementById('refreshDevices'),
    toggleAudio: document.getElementById('toggleAudio'),
    toggleVideo: document.getElementById('toggleVideo')
};

// 初始化
async function init() {
    generateCode();
    setupEventListeners();
    await initMediaDevices();
    connectSignalingServer();
}

// 生成随机验证码
function generateCode() {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let code = '';
    for (let i = 0; i < CONFIG.CODE_LENGTH; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    myCode = code;
    elements.myCode.textContent = code;
}

// 连接信令服务器
function connectSignalingServer() {
    updateStatus('正在连接服务器...', 'connecting');
    
    socket = io(CONFIG.SIGNALING_SERVER, {
        transports: ['websocket', 'polling']
    });

    socket.on('connect', () => {
        updateStatus('已连接到服务器', 'connected');
        socket.emit('register', myCode);
    });

    socket.on('disconnect', () => {
        updateStatus('服务器连接断开', 'error');
    });

    socket.on('peer_connected', (data) => {
        updateStatus(`已连接到用户: ${data.peerCode}`, 'connected');
        if (isCaller) {
            createPeerConnection();
            startCall();
        }
    });

    socket.on('offer', (data) => {
        handleOffer(data);
    });

    socket.on('answer', (data) => {
        handleAnswer(data);
    });

    socket.on('candidate', (data) => {
        handleCandidate(data);
    });

    socket.on('error', (error) => {
        updateStatus(`错误: ${error}`, 'error');
    });
}

// 创建PeerConnection
function createPeerConnection() {
    peerConnection = new RTCPeerConnection({
        iceServers: CONFIG.ICE_SERVERS
    });

    // 添加本地流
    if (localStream) {
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
    }

    // ICE候选处理
    peerConnection.onicecandidate = (event) => {
        if (event.candidate && socket.connected) {
            socket.emit('candidate', {
                to: peerCode,
                candidate: event.candidate
            });
        }
    };

    // 远程流处理
    peerConnection.ontrack = (event) => {
        elements.remoteVideo.srcObject = event.streams[0];
    };

    // 连接状态变化
    peerConnection.onconnectionstatechange = () => {
        console.log('连接状态:', peerConnection.connectionState);
        switch(peerConnection.connectionState) {
            case 'connected':
                updateStatus('通话已连接', 'connected');
                break;
            case 'disconnected':
                updateStatus('连接断开', 'error');
                break;
            case 'failed':
                updateStatus('连接失败', 'error');
                break;
        }
    };
}

// 开始通话
async function startCall() {
    try {
        const offer = await peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
        });
        
        await peerConnection.setLocalDescription(offer);
        
        socket.emit('offer', {
            to: peerCode,
            offer: offer
        });
        
        updateStatus('正在呼叫对方...', 'connecting');
    } catch (error) {
        console.error('创建offer失败:', error);
        updateStatus('呼叫失败', 'error');
    }
}

// 处理Offer
async function handleOffer(data) {
    if (!peerConnection) {
        createPeerConnection();
    }
    
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    
    socket.emit('answer', {
        to: data.from,
        answer: answer
    });
    
    updateStatus('已接听通话', 'connected');
    elements.callBtn.disabled = true;
    elements.hangupBtn.disabled = false;
}

// 处理Answer
async function handleAnswer(data) {
    if (peerConnection) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        updateStatus('通话已连接', 'connected');
        elements.callBtn.disabled = true;
        elements.hangupBtn.disabled = false;
    }
}

// 处理Candidate
async function handleCandidate(data) {
    if (peerConnection) {
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (error) {
            console.error('添加ICE候选失败:', error);
        }
    }
}

// 初始化媒体设备
async function initMediaDevices() {
    try {
        await loadDeviceList();
        
        const constraints = {
            audio: { deviceId: elements.micSelect.value ? { exact: elements.micSelect.value } : undefined },
            video: { deviceId: elements.cameraSelect.value ? { exact: elements.cameraSelect.value } : undefined }
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        elements.localVideo.srcObject = localStream;
        
        updateStatus('摄像头和麦克风已就绪', 'connected');
    } catch (error) {
        console.error('获取媒体设备失败:', error);
        updateStatus('无法访问摄像头/麦克风', 'error');
    }
}

// 加载设备列表
async function loadDeviceList() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        // 清空选项
        elements.cameraSelect.innerHTML = '<option value="">选择摄像头</option>';
        elements.micSelect.innerHTML = '<option value="">选择麦克风</option>';
        
        // 填充设备列表
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `${device.kind} ${device.deviceId.slice(0, 5)}`;
            
            if (device.kind === 'videoinput') {
                elements.cameraSelect.appendChild(option.cloneNode(true));
            } else if (device.kind === 'audioinput') {
                elements.micSelect.appendChild(option);
            }
        });
    } catch (error) {
        console.error('获取设备列表失败:', error);
    }
}

// 设置事件监听器
function setupEventListeners() {
    // 连接按钮
    elements.connectBtn.addEventListener('click', () => {
        peerCode = elements.peerCodeInput.value.trim().toUpperCase();
        if (peerCode.length === CONFIG.CODE_LENGTH) {
            updateStatus(`正在连接用户: ${peerCode}`, 'connecting');
            isCaller = true;
            
            socket.emit('connect_to_peer', {
                from: myCode,
                to: peerCode
            });
            
            elements.callBtn.disabled = false;
        } else {
            alert('请输入有效的6位验证码');
        }
    });

    // 通话按钮
    elements.callBtn.addEventListener('click', () => {
        if (peerCode && localStream) {
            createPeerConnection();
            startCall();
        }
    });

    // 挂断按钮
    elements.hangupBtn.addEventListener('click', hangup);

    // 刷新设备列表
    elements.refreshDevices.addEventListener('click', loadDeviceList);

    // 切换音频
    elements.toggleAudio.addEventListener('click', () => {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isAudioEnabled = audioTrack.enabled;
                elements.toggleAudio.innerHTML = `
                    <i class="fas fa-microphone${!isAudioEnabled ? '-slash' : ''}"></i>
                    ${isAudioEnabled ? '静音' : '取消静音'}
                `;
            }
        }
    });

    // 切换视频
    elements.toggleVideo.addEventListener('click', () => {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                isVideoEnabled = videoTrack.enabled;
                elements.toggleVideo.innerHTML = `
                    <i class="fas fa-video${!isVideoEnabled ? '-slash' : ''}"></i>
                    ${isVideoEnabled ? '关闭视频' : '开启视频'}
                `;
            }
        }
    });

    // 设备切换
    elements.cameraSelect.addEventListener('change', async () => {
        await restartMediaStream();
    });

    elements.micSelect.addEventListener('change', async () => {
        await restartMediaStream();
    });

    // 输入框回车连接
    elements.peerCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            elements.connectBtn.click();
        }
    });
}

// 重新启动媒体流
async function restartMediaStream() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    
    await initMediaDevices();
    
    // 如果正在通话中，需要重新添加轨道
    if (peerConnection && peerConnection.signalingState !== 'closed') {
        localStream.getTracks().forEach(track => {
            const sender = peerConnection.getSenders().find(s => 
                s.track && s.track.kind === track.kind
            );
            if (sender) {
                sender.replaceTrack(track);
            } else {
                peerConnection.addTrack(track, localStream);
            }
        });
    }
}

// 挂断通话
function hangup() {
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    if (socket && peerCode) {
        socket.emit('disconnect_peer', { to: peerCode });
    }
    
    elements.remoteVideo.srcObject = null;
    elements.callBtn.disabled = true;
    elements.hangupBtn.disabled = true;
    peerCode = null;
    isCaller = false;
    
    updateStatus('通话已结束', 'connected');
}

// 更新状态显示
function updateStatus(message, type = '') {
    elements.connectionStatus.textContent = message;
    elements.connectionStatus.className = 'status';
    if (type) {
        elements.connectionStatus.classList.add(`status-${type}`);
    }
}

// 页面加载完成
window.addEventListener('load', init);

// 页面关闭前清理
window.addEventListener('beforeunload', () => {
    hangup();
    if (socket) {
        socket.disconnect();
    }
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
});
        
